#include "rand.h"
#include <stdint.h>

uint32_t rand_state[625] = {0};
uint32_t rand_state_idx = 0;
const uint32_t rand_correction[256] = {
        0x00,0x00,0x00,0x00,
        0xdf,0xb0,0x08,0x99,
        0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
};

//original addr: 0x0800303c
void rand_init(uint32_t _seed){
    uint32_t seed;

    for(int i = 0; i < 624; i++){
        seed = _seed * 690069 + 1;
        rand_state[i] = (_seed & 0xffff0000) | seed >> 0x10;
        _seed = seed * 690069 + 1;
    }
    rand_state_idx = 624;
}

//original addr: 0x080030a4
uint32_t rand_gen(){
    uint32_t* p;
    uint32_t* p2;
    if (rand_state_idx > 623){
        if(rand_state_idx == 625){
            rand_init(4357);
        }
        uint32_t i = 0;
        p = rand_state;
        while(i < 227) {
            *p = rand_state[i + 397] ^ ((p[0] & 0x80000000) | (p[1] & 0x7fffffff)) >> 1 ^ rand_correction[p[1]];
            p++;
            i++;
        }
        if(i < 623){
            p  = &rand_state[i];
            p2 = (uint32_t*)(i * 4 + 0x2004ea4);
            do {
                *p = *p2 ^ ((p[0] & 0x80000000) | (p[1] & 0x7fffffff)) >> 1 ^ rand_correction[p[0]];
                p2++;
                p++;
                i++;
            } while (i < 623);
        }
        //TODO: figure out if the line that was here is actually useless
        rand_state_idx = 0;
    }
    p = &rand_state[rand_state_idx];
    rand_state_idx++;
    uint32_t v = *p ^ *p >> 0xB;
    v = v ^ (v & 0x13a58ad) << 7;
    v = v ^ (v & 0x1df8c) << 0xf;
    return v ^ v >> 0x12;
}